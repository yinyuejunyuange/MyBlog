<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.oyyj.blogservice.mapper.UserBehaviorMapper">
    <insert id="addUserBehavior">
        INSERT INTO user_behavior
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                user_id,
            </if>
            <if test="blogId != null">
                blog_id,
            </if>
            <if test="behaviorEnum != null and behaviorEnum.code != null">
                behavior_type,
            </if>
            <if test="behaviorEnum != null and behaviorEnum.weight != null">
                weight,
            </if>
            is_delete
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                #{userId},
            </if>
            <if test="blogId != null">
                #{blogId},
            </if>
            <if test="behaviorEnum != null and behaviorEnum.code != null">
                #{behaviorEnum.code},
            </if>
            <if test="behaviorEnum != null and behaviorEnum.weight != null">
                #{behaviorEnum.weight},
            </if>
            0
        </trim>
    </insert>


    <select id="getUserIdList" resultType="java.lang.Long">
        SELECT DISTINCT userId
        FROM user_behavior

    </select>
    <select id="getUserActivityLevel" resultType="org.oyyj.blogservice.config.pojo.UserActivityLevel">
        SELECT
            user_id AS userId,
            SUM(weight *
                CASE
                    WHEN DATEDIFF(NOW(),create_time) > 7 THEN 0.5
                    WHEN DATEDIFF(NOW(),create_time) > 30 THEN 0.3
                    ELSE 1.0
                END
                ) AS weightedActivity,
            COUNT(*) AS behaviorCount,
            MAX(create_time) AS lastActTime
        FROM user_behavior
        GROUP BY user_id
        ORDER BY weightedActivity DESC , lastActTime DESC
        LIMIT 5000
    </select>
    <select id="getBlogActivityLevel" resultType="org.oyyj.blogservice.config.pojo.BlogActivityLevel">
        SELECT
            blog_id AS blogId,
            SUM(weight *
                CASE
                    WHEN DATEDIFF(NOW(),create_time) > 7 THEN 0.5
                    WHEN DATEDIFF(NOW(),create_time) > 30 THEN 0.3
                    ELSE 1.0
                    END
            ) AS weightedActivity
        FROM user_behavior
        <where>
            <if test="userId != '' and userId != null ">
                 blog_id NOT IN (SELECT blog_id FROM user_behavior WHERE user_id = #{userId})
            </if>
        </where>
        GROUP BY blog_id
        ORDER BY weightedActivity DESC
            LIMIT 5000
    </select>
</mapper>
